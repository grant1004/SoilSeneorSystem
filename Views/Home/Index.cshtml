<!-- Views/Home/Index.cshtml -->
@{
    ViewData["Title"] = "土壤濕度監控";
}

<div class="text-center">
    <h1 class="display-4">土壤濕度監控系統
        <button id="waterButton" class="btn btn-primary">澆水</button>
    </h1>
    
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">即時數據</h5>
            <p class="card-text">電壓: <span id="voltage">--</span> V</p>
            <p class="card-text">濕度: <span id="moisture">--</span> %</p>
            <p class="card-text">最後更新時間: <span id="timestamp">--</span></p>
        </div>
    </div>

    <!-- 添加圖表容器 -->
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">濕度歷史趨勢</h5>
            <canvas id="moistureChart"></canvas>
        </div>
    </div>

    <!-- 添加澆水記錄容器 -->
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">澆水記錄</h5>
            <div id="wateringRecords">
                <p class="text-muted">載入中...</p>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <script>

        // 初始化圖表數據
        const maxDataPoints = 8640; // 1day => 1440 分鐘 
        const moistureData = {
            labels: [],
            datasets: [{
                label: '濕度 (%)',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        };

        // 創建圖表
        const ctx = document.getElementById('moistureChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: moistureData,
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {
                                minute: 'HH:mm'
                            }
                        },
                        title: {
                            display: true,
                            text: '時間'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: '濕度 (%)'
                        }
                    }
                },
                animation: false,
                responsive: true
            }
        });

        function updateData() {
            fetch('/Home/GetData')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('voltage').textContent = data.voltage.toFixed(4);
                    document.getElementById('moisture').textContent = data.moisture.toFixed(2);
                    document.getElementById('timestamp').textContent =  new Date(data.timestamp * 1000).toLocaleString();
                    // 更新圖表
                    const timestamp = new Date(data.timestamp * 1000);

                    // 每1分鐘添加一個數據點 10s * 1000 
                    if (moistureData.labels.length === 0 ||
                        timestamp - new Date(moistureData.labels[moistureData.labels.length - 1]) >= 10000) {

                        moistureData.labels.push(timestamp);
                        moistureData.datasets[0].data.push(data.moisture);

                        if (moistureData.labels.length > maxDataPoints) {
                            moistureData.labels.shift();
                            moistureData.datasets[0].data.shift();
                        }

                        chart.update();
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        
        

        // 更新澆水記錄
        function updateWateringRecords() {
            console.log('正在更新澆水記錄...');
            fetch('/Home/GetWateringRecords')
                .then(response => response.json())
                .then(records => {
                    console.log('取得澆水記錄:', records);
                    const recordsContainer = document.getElementById('wateringRecords');
                    
                    if (records.length === 0) {
                        recordsContainer.innerHTML = '<p class="text-muted">尚無澆水記錄</p>';
                        return;
                    }
                    
                    let html = '<div class="table-responsive"><table class="table table-striped table-sm">';
                    html += '<thead><tr><th>時間</th><th>類型</th><th>澆水前濕度</th><th>澆水後濕度</th><th>濕度變化</th></tr></thead><tbody>';
                    
                    records.forEach(record => {
                        const time = new Date(record.wateringTime).toLocaleString();
                        const type = record.type === 0 ? '自動' : record.type === 1 ? '手動' : '檢測';
                        const typeClass = record.type === 0 ? 'badge-success' : record.type === 1 ? 'badge-primary' : 'badge-info';
                        const beforeMoisture = record.moistureBefore.toFixed(1);
                        const afterMoisture = record.moistureAfter > 0 ? record.moistureAfter.toFixed(1) : '--';
                        const change = record.moistureChange > 0 ? '+' + record.moistureChange.toFixed(1) : '--';
                        
                        html += `<tr>
                            <td>${time}</td>
                            <td><span class="badge ${typeClass}">${type}</span></td>
                            <td>${beforeMoisture}%</td>
                            <td>${afterMoisture}%</td>
                            <td>${change}%</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    recordsContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error fetching watering records:', error);
                    document.getElementById('wateringRecords').innerHTML = '<p class="text-danger">載入記錄失敗</p>';
                });
        }

        // 每秒更新一次數據
        setInterval(updateData, 1000);
        updateData();  // 立即更新一次
        
        // 每10秒更新一次澆水記錄
        setInterval(updateWateringRecords, 10000);
        updateWateringRecords();  // 立即更新一次
    </script>
    <script>
        $(document).ready(function () {
            $("#waterButton").click(function () {
                $(this).prop('disabled', true);

                $.post('/Home/WaterPlant', function (result) {
                    if (result.success) {
                        alert('澆水成功');
                        // 立即更新澆水記錄
                        updateWateringRecords();
                    } else {
                        alert('澆水失敗');
                    }
                })
                    .fail(function () {
                        alert('系統錯誤');
                    })
                    .always(function () {
                        setTimeout(function () {
                            $("#waterButton").prop('disabled', false);
                        }, 5000);  // 5秒後可以再次點擊
                    });
            });
        });
    </script>
}